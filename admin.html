<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - xxxbdpro.xyz</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #e50914; --dark-color: #1a202c; --light-dark-color: #2d3748;
            --gray-color: #a0aec0; --white-color: #f7fafc;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--dark-color); color: var(--white-color); }

        /* Login View */
        .login-container { display: flex; justify-content: center; align-items: center; height: 100vh; }
        .login-form { background-color: var(--light-dark-color); padding: 40px; border-radius: 8px; width: 100%; max-width: 400px; }
        .login-form h2 { text-align: center; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input { width: 100%; padding: 10px; background-color: var(--dark-color); border: 1px solid #4a5568; border-radius: 4px; color: var(--white-color); }
        .btn { display: block; width: 100%; padding: 12px; background-color: var(--primary-color); color: var(--white-color); border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.2s; }
        .btn:hover { background-color: #c50812; }
        .btn:disabled { background-color: #555; cursor: not-allowed;}
        .toggle-form { text-align: center; margin-top: 15px; color: var(--gray-color); cursor: pointer; }
        .auth-error { color: #f56565; margin-top: 10px; text-align: center; min-height: 20px;}

        /* Admin Layout */
        .admin-layout { display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background-color: var(--light-dark-color); padding: 20px; flex-shrink: 0; display: flex; flex-direction: column; }
        .sidebar h2 { color: var(--primary-color); text-align: center; margin-bottom: 30px; }
        .sidebar-menu { flex-grow: 1; }
        .sidebar-menu ul { list-style: none; }
        .sidebar-menu li a { display: flex; align-items: center; color: var(--white-color); text-decoration: none; padding: 15px; border-radius: 4px; margin-bottom: 10px; transition: background-color 0.2s; }
        .sidebar-menu li a.active, .sidebar-menu li a:hover { background-color: var(--primary-color); }
        .sidebar-menu li a i { margin-right: 12px; width: 20px; text-align: center;}
        #logoutBtn { background: none; border: none; color: var(--white-color); padding: 15px; width: 100%; text-align: left; font-size: 16px; cursor: pointer; border-top: 1px solid #4a5568; margin-top: 20px;}

        .main-content { flex-grow: 1; padding: 40px; overflow-y: auto; }
        .page { display: none; }
        .page.active { display: block; }
        .page-header { margin-bottom: 30px; font-size: 28px; border-bottom: 1px solid #4a5568; padding-bottom: 15px;}

        /* Dashboard */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .stat-card { background-color: var(--light-dark-color); padding: 20px; border-radius: 8px; }
        .stat-card i { font-size: 24px; margin-bottom: 10px; color: var(--primary-color); }
        .stat-card h3 { font-size: 28px; }
        .stat-card p { color: var(--gray-color); }
        
        /* Forms */
        .form-container { background-color: var(--light-dark-color); padding: 30px; border-radius: 8px; }
        .form-container input, .form-container select { width: 100%; padding: 12px; margin-bottom: 20px; background-color: var(--dark-color); border: 1px solid #4a5568; border-radius: 4px; color: var(--white-color); }
        .form-container .checkbox-group { display: flex; align-items: center; margin-bottom: 20px; }
        .form-container .checkbox-group input { width: auto; margin-right: 10px; }
        
        /* Table */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #4a5568; }
        th { background-color: #4a5568; }
        .action-buttons button { background: none; border: none; cursor: pointer; font-size: 16px; margin-right: 10px; }
        .btn-edit { color: #4299e1; }
        .btn-delete { color: #f56565; }
        
        #admin-panel { display: none; }
    </style>
</head>
<body>

    <div id="auth-view">
        <div class="login-container">
            <div id="loginForm" class="login-form">
                <h2>Admin Login</h2>
                <div id="loginError" class="auth-error"></div>
                <form id="login-form-element">
                    <div class="form-group"><label for="loginEmail">Email</label><input type="email" id="loginEmail" required></div>
                    <div class="form-group"><label for="loginPassword">Password</label><input type="password" id="loginPassword" required></div>
                    <button type="submit" class="btn">Login</button>
                </form>
                <p class="toggle-form" onclick="toggleAuthForms()">Don't have an account? Create one.</p>
            </div>
            <div id="signupForm" class="login-form" style="display: none;">
                <h2>Create Admin Account</h2>
                <div id="signupError" class="auth-error"></div>
                <form id="signup-form-element">
                    <div class="form-group"><label for="signupEmail">Email</label><input type="email" id="signupEmail" required></div>
                    <div class="form-group"><label for="signupPassword">Password</label><input type="password" id="signupPassword" required></div>
                    <button type="submit" class="btn">Create Account</button>                </form>
                <p class="toggle-form" onclick="toggleAuthForms()">Already have an account? Login.</p>
            </div>
        </div>
    </div>

    <div id="admin-panel" class="admin-layout">
        <aside class="sidebar">
            <h2>xxxbdpro.xyz</h2>
            <nav class="sidebar-menu">
                <ul>
                    <li><a href="#dashboard" class="nav-link active"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                    <li><a href="#create-post" class="nav-link"><i class="fas fa-plus-square"></i> Create Post</a></li>
                    <li><a href="#manage-posts" class="nav-link"><i class="fas fa-list"></i> Manage Posts</a></li>
                    <li><a href="#settings" class="nav-link"><i class="fas fa-cog"></i> Settings</a></li>
                </ul>
            </nav>
            <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </aside>

        <main class="main-content">
            <!-- Dashboard Page -->
            <section id="dashboard" class="page active">
                <h1 class="page-header">Dashboard</h1>
                <div class="stats-grid">
                    <div class="stat-card"><i class="fas fa-file-video"></i><h3 id="totalPosts">0</h3><p>Total Posts</p></div>
                    <div class="stat-card"><i class="fas fa-eye"></i><h3 id="totalViews">0</h3><p>Total Views</p></div>
                    <div class="stat-card"><i class="fas fa-thumbs-up"></i><h3 id="totalLikes">0</h3><p>Total Likes</p></div>
                    <div class="stat-card"><i class="fas fa-share"></i><h3 id="totalShares">0</h3><p>Total Shares</p></div>
                </div>
            </section>
            
            <!-- Create Post Page -->
            <section id="create-post" class="page">

                <h1 class="page-header" id="form-header">Create New Post</h1>
                <div class="form-container">
                    <form id="postForm">
                        <input type="hidden" id="postId">
                        <label for="postTitle">Post Title</label>
                        <input type="text" id="postTitle" required>
                        
                        <label for="postThumbnailUrl">Thumbnail Image URL</label>
                        <input type="text" id="postThumbnailUrl" placeholder="Paste image URL or upload below">
                        <label for="thumbnailUpload">Or Upload Thumbnail (via Imgbb)</label>
                        <input type="file" id="thumbnailUpload" accept="image/*">
                        
                        <!-- ### MODIFIED SECTION ### -->
                        <label for="postVideoUrl">Video URL</label>
                        <input type="url" id="postVideoUrl" placeholder="Paste video direct link here" required>
                        <!-- ### END OF MODIFIED SECTION ### -->
                        
                        <label for="postCategory">Category (Optional)</label>
                        <select id="postCategory"></select>
                        <label for="newCategory">Or Add New Category</label>
                        <input type="text" id="newCategory" placeholder="e.g., Action, Comedy">
                        
                        <div class="checkbox-group"><input type="checkbox" id="confirmCheck" required><label for="confirmCheck">I confirm all information is correct.</label></div>
                        <button type="submit" class="btn" id="publishBtn">Publish Now</button>
                    </form>
                </div>
            </section>

            <!-- Manage Posts Page -->
            <section id="manage-posts" class="page">
                <h1 class="page-header">Manage Posts</h1>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Title</th><th>Category</th><th>Views</th><th>Date</th><th>Actions</th></tr></thead>
                        <tbody id="postsTableBody"></tbody>
                    </table>
                </div>
            </section>
            
            <!-- Settings Page -->
            <section id="settings" class="page">
                <h1 class="page-header">Settings</h1>
                <div class="form-container">
                    <form id="settingsForm">
                        <label for="randomAdLink">Random Link for Video Player Click</label>
                        <input type="url" id="randomAdLink" placeholder="https://example.com/ad" required>
                        <button type="submit" class="btn">Save Settings</button>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, collection, getDocs, serverTimestamp, query, orderBy, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // Firebase Configuration (Using key from user prompt)
        const firebaseConfig = {
            apiKey: "AIzaSyB2JqxpBdOSlrUA2iXDPIE45YRNj8bMgYM",
            authDomain: "chat-my-talk-my-4f7cd.firebaseapp.com",
            projectId: "chat-my-talk-my-4f7cd",
            storageBucket: "chat-my-talk-my-4f7cd.firebasestorage.app",
            messagingSenderId: "455735834971",
            appId: "1:455735834971:web:9f3b5740987fe8c6c4027e"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Imgbb API Key (Using key from user's provided code)
        const IMGBB_API_KEY = "7111e3e5c1f3723d44151b01c44df296";
        // Catbox user hash removed as requested

        // --- AUTHENTICATION & NAVIGATION LOGIC (UNCHANGED) ---
        const authView = document.getElementById('auth-view');
        const adminPanel = document.getElementById('admin-panel');

        function toggleAuthForms() {
            document.getElementById('loginForm').style.display = document.getElementById('loginForm').style.display === 'none' ? 'block' : 'none';
            document.getElementById('signupForm').style.display = document.getElementById('signupForm').style.display === 'none' ? 'block' : 'none';
        }
        window.toggleAuthForms = toggleAuthForms;

        onAuthStateChanged(auth, user => {
            if (user) {
                authView.style.display = 'none'; adminPanel.style.display = 'flex'; initAdminPanel();
            } else {
                authView.style.display = 'block'; adminPanel.style.display = 'none';
            }
        });

        document.getElementById('signup-form-element').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signupEmail').value; const password = document.getElementById('signupPassword').value;
            const errorDiv = document.getElementById('signupError');
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "users", userCredential.user.uid), { email: userCredential.user.email, role: 'admin', createdAt: serverTimestamp() });
                errorDiv.textContent = '';
            } catch (error) { errorDiv.textContent = error.message; }
        });

        document.getElementById('login-form-element').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value; const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            try { await signInWithEmailAndPassword(auth, email, password); errorDiv.textContent = ''; } 
            catch (error) { errorDiv.textContent = error.message; }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));
        
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(targetId).classList.add('active');
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                if(targetId === 'manage-posts') loadManagePosts();
                if(targetId === 'dashboard') loadDashboardStats();
                if(targetId === 'create-post') resetPostForm();
            });
        });
        
        function initAdminPanel() { loadCategories(); loadDashboardStats(); loadSettings(); }

        async function loadCategories() {
            const categorySelect = document.getElementById('postCategory');
            categorySelect.innerHTML = '<option value="">Select a category (optional)</option>';
            const querySnapshot = await getDocs(query(collection(db, 'categories'), orderBy('name')));
            querySnapshot.forEach(doc => {
                const option = document.createElement('option');
                option.value = doc.id;
                option.textContent = doc.data().name;
                categorySelect.appendChild(option);
            });
        }

        async function loadDashboardStats() {
            const querySnapshot = await getDocs(collection(db, 'posts'));
            let totalViews = 0, totalLikes = 0, totalShares = 0;
            querySnapshot.forEach(doc => {
                const post = doc.data();
                totalViews += post.views || 0; totalLikes += post.likes || 0; totalShares += post.shares || 0;
            });
            document.getElementById('totalPosts').textContent = querySnapshot.size;
            document.getElementById('totalViews').textContent = totalViews;
            document.getElementById('totalLikes').textContent = totalLikes;
            document.getElementById('totalShares').textContent = totalShares;
        }

        // --- POST FORM SUBMISSION LOGIC (MODIFIED) ---
        document.getElementById('postForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const publishBtn = document.getElementById('publishBtn');
            publishBtn.disabled = true;
            publishBtn.textContent = 'Processing...';

            try {
                const postId = document.getElementById('postId').value;
                let thumbnailUrl = document.getElementById('postThumbnailUrl').value;
                const videoUrl = document.getElementById('postVideoUrl').value; // Get video URL from input field
                let categoryId = document.getElementById('postCategory').value;
                const newCategoryName = document.getElementById('newCategory').value.trim();

                // 1. Thumbnail Upload Logic (unchanged, but checking for file selection)
                const thumbnailFile = document.getElementById('thumbnailUpload').files[0];
                if (thumbnailFile) {
                    thumbnailUrl = await uploadToImgbb(thumbnailFile);
                }

                // 2. New Category Logic (unchanged)
                if (newCategoryName) {
                    const newCategoryRef = await addDoc(collection(db, 'categories'), { name: newCategoryName });
                    categoryId = newCategoryRef.id;
                }

                // 3. Validation (checking if thumbnail URL exists either from input or upload)
                if (!thumbnailUrl) {
                    throw new Error("Thumbnail URL or uploaded file is required.");
                }
                if (!videoUrl) {
                    // This check might be redundant due to 'required' attribute in HTML, but good for safety.
                    throw new Error("Video URL is required.");
                }

                const postData = {
                    title: document.getElementById('postTitle').value,
                    thumbnailUrl, 
                    videoUrl, 
                    categoryId,
                    publishDate: serverTimestamp(), 
                    updatedAt: serverTimestamp(),
                    views: 0, likes: 0, shares: 0
                };
                
                if(postId) await updateDoc(doc(db, "posts", postId), postData);
                else await addDoc(collection(db, "posts"), postData);
               
                alert(`Post ${postId ? 'updated' : 'created'} successfully!`);
                resetPostForm();
                loadCategories();
                document.querySelector('.nav-link[href="#manage-posts"]').click();
            } catch (error) {
                console.error("Error saving post: ", error);
                alert("Error: " + error.message);
            } finally {
                publishBtn.disabled = false;
                publishBtn.textContent = 'Publish Now';
            }
        });

        // --- MANAGE POSTS LOGIC (UNCHANGED) ---
        async function loadManagePosts() {
            const tableBody = document.getElementById('postsTableBody');
            tableBody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';
            const categories = {};
            const catSnapshot = await getDocs(collection(db, 'categories'));
            catSnapshot.forEach(doc => { categories[doc.id] = doc.data().name; });
            
            const querySnapshot = await getDocs(query(collection(db, 'posts'), orderBy('publishDate', 'desc')));
            tableBody.innerHTML = '';
            querySnapshot.forEach(doc => {
                const post = doc.data();
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${post.title}</td>
                    <td>${categories[post.categoryId] || 'N/A'}</td>
                    <td>${post.views || 0}</td>
                    <td>${post.publishDate.toDate().toLocaleDateString()}</td>
                    <td class="action-buttons">
                        <button class="btn-edit" data-id="${doc.id}"><i class="fas fa-edit"></i></button>
                        <button class="btn-delete" data-id="${doc.id}"><i class="fas fa-trash"></i></button>
                    </td>`;
                tableBody.appendChild(row);
            });
        }
        
        document.getElementById('postsTableBody').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if(!button) return;
            const id = button.dataset.id;
            
            if(button.classList.contains('btn-delete')) {
                if(confirm('Are you sure you want to delete this post?')) {
                    await deleteDoc(doc(db, "posts", id));
                    loadManagePosts();
                }
            } else if(button.classList.contains('btn-edit')) {
                const docSnap = await getDoc(doc(db, 'posts', id));
                if (docSnap.exists()) {
                    const post = docSnap.data();
                    document.getElementById('postId').value = id;
                    document.getElementById('postTitle').value = post.title;
                    document.getElementById('postThumbnailUrl').value = post.thumbnailUrl;
                    document.getElementById('postVideoUrl').value = post.videoUrl;
                    document.getElementById('postCategory').value = post.categoryId;
                    document.getElementById('form-header').textContent = 'Edit Post';
                    document.getElementById('publishBtn').textContent = 'Update Post';
                    document.querySelector('.nav-link[href="#create-post"]').click();
                }
            }
        });

        function resetPostForm() {
            document.getElementById('postForm').reset();
            document.getElementById('postId').value = '';
            document.getElementById('form-header').textContent = 'Create New Post';
            document.getElementById('publishBtn').textContent = 'Publish Now';
        }

        // --- IMAGE UPLOAD FUNCTION (UNCHANGED) ---
        async function uploadToImgbb(file) {
            const formData = new FormData(); 
            formData.append('image', file);
            // Using API key from your code: 7111e3e5c1f3723d44151b01c44df296
            const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { 
                method: 'POST', 
                body: formData 
            });
            const data = await response.json();
            if (data.success) {
                return data.data.url; 
            } else { 
                throw new Error(data.error.message || 'Imgbb upload failed');
            }
        }
        
        // --- SETTINGS LOGIC (UNCHANGED) ---
        async function loadSettings() {
             const docSnap = await getDoc(doc(db, 'site_settings', 'ads'));
             if (docSnap.exists()) document.getElementById('randomAdLink').value = docSnap.data().randomLink || '';
        }
        
        document.getElementById('settingsForm').addEventListener('submit', async(e) => {
            e.preventDefault();
            await setDoc(doc(db, "site_settings", "ads"), { randomLink: document.getElementById('randomAdLink').value });
            alert('Settings saved!');
        });
        
    </script></body>
</html>
